# 姓名消歧项目 (RND) 开发记录 (v2.2 - 健壮性逻辑与日志规范版)

## 1. 项目当前结构
- **根目录**: 
  - `main.py`: **调度中心**。集成数据加载、**严格断点校验**及随机抽样逻辑。
  - `config.py`: **全局配置**。管理 DeepSeek 接口参数、DSPy 初始化配置。
  - `output/analysis_log.jsonl`: **详细分析日志**。记录每道题的 Token 消耗、候选人数及推理过程，支持**自动覆盖重置**。
  - `output/result.json`: **标准预测输出**。存储格式对齐官方要求，支持实时增量保存。
- **src/**: 
  - `candidate_generator.py`: **第一阶段：召回**。同名检索，支持空集返回以触发 NIL 逻辑。
  - `feature_extractor.py`: **第二阶段：特征提取**。构造包含机构、合作者画像的文本上下文。
  - `llm_decider.py`: **第三阶段：智能决策**。负责 Token 监控与 DSPy 调用，支持传入全局索引实现序号对齐。
  - `evaluator.py`: **评分模块**。通过解析 `analysis_log.jsonl` 提供成本监控。

## 2. 技术栈更新 
- **框架**: DSPy (Chain of Thought) ―― 强化逻辑推理，消除 `forward` 调用警告。
- **文件 IO**: 
  - **原子化记录**: 仅在 LLM 成功返回结果后写入 `analysis_log.jsonl`，防止“任务开始即标记成功”导致的漏处理漏洞。
  - **覆盖逻辑**: 启动时若无有效断点，自动执行 `open(LOG_PATH, 'w')` 以重置进度。

## 3. 当前开发进度
### ? 已完成
- [x] **严格断点续传**: 通过检查日志行中是否存在 `stats` 字段，确保仅跳过真正处理成功的任务。
- [x] **无候选人 (NIL) 自动判别**: 
    - 召回率为 0 时自动判定为 `"new_author"`。
    - **修复**: 自动判定的 NIL 同样记录至 `analysis_log.jsonl`，确保断点逻辑闭环。
- [x] **序号显示优化**: 修复了断点重启后进度显示为 `[3/2]` 的异常，通过 `initial_skipped` 变量实现全局进度对齐。
- [x] **Token 监控**: 实时打印 Input Tokens 消耗，识别并跳过超过模型窗口（如 23,625 tokens）的极端任务。

### ?? 优化中 (指标对齐与性能)
- [ ] **多线程并行化**: 针对 API 响应时延，计划将 `main.py` 的 `for` 循环改为线程池并行处理。
- [ ] **超长上下文截断**: 针对候选人过多导致的 Token 溢出（> 16,384），开发基于相似度的候选人动态截断策略。
- [ ] **结果集自动恢复**: 启动时从 `analysis_log.jsonl` 反向构建 `results` 字典，确保输出 JSON 的完整性。

## 4. 后续开发计划
1. **全量数据跑通**: 逐步将 `random.sample` 的规模扩大至全量 13,914 条数据。
2. **成本评估报告**: 利用分析日志统计总 Token 消耗与任务平均单价。
3. **特征增强**: 引入论文摘要（Abstract）的关键信息以提升重名大户的区分度。

---
*最后更新日期: 2026-01-22*